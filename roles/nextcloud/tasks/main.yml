- name: Create nextcloud directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ nextcloud_dir }}"
    - "{{ nextcloud_dir }}/web"
    - "{{ nextcloud_dir }}/nextcloud"
- name: Copy configuration files
  copy  :
    src: '{{item}}'
    dest: '{{ nextcloud_dir }}/{{item}}'
  loop:
    - nextcloud/Dockerfile
    - nextcloud/supervisord.conf
    - web/Dockerfile
    - web/nginx.conf
- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ nextcloud_dir }}/docker-compose.yml"
- name: Run NextCloud Docker containers
  docker_compose:
    project_src: "{{ nextcloud_dir }}/"
    build: yes
- name: Configure weekly updates on Monday at 07:00
  cron:
    name: Update NextCloud Docker containers
    minute: "0"
    hour: "7"
    weekday: "1"
    job: "/usr/local/bin/docker-compose -f {{ nextcloud_dir }}/docker-compose.yml pull && /usr/local/bin/docker-compose -f {{ nextcloud_dir }}/docker-compose.yml up -d --build"
